<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dalswin School Chatbot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Firebase App (the core Firebase SDK) and Auth SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <style>
    :root {
      /* --- Light Mode Default (your specified colors) --- */
      --primary-accent: #5a8f7b;
      --background-light: #f9f9f9;
      --secondary-accent: #b5bdbc;
      --text-dark: #202123;
      --text-light: #5c6670;
      --border-color: #e0e4e7;
      --user-bubble-bg: #ffffff;
      --bot-bubble-bg: #f0f5f2;
      --input-bg: #ffffff;
      --button-primary: var(--primary-accent);
      --button-hover: #4a7966;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
      --error-color: #e74c3c;
      --link-color: #3498db;
      --typing-dot-color: var(--primary-accent);
      --sidebar-bg: #2c3e50;
      --sidebar-text: #ecf0f1;
      --sidebar-border: rgba(255,255,255,0.15);
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --info-bg: #d6eaf8;
      --info-text: #2874a6;
      --avatar-bg: #3498db;
    }

    /* --- Dark Mode Variables --- */
    .dark-mode {
      --primary-accent: #6abf8b;
      --background-light: #1a1d21;
      --secondary-accent: #3a3a3a;
      --text-dark: #e4e4e4;
      --text-light: #b0b8bf;
      --border-color: #37474f;
      --user-bubble-bg: #253341;
      --bot-bubble-bg: #1e2b38;
      --input-bg: #2a3b4d;
      --button-primary: var(--primary-accent);
      --button-hover: #5daa7d;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.35);
      --error-color: #e74c3c;
      --link-color: #5dade2;
      --typing-dot-color: var(--primary-accent);
      --sidebar-bg: #1c2833;
      --sidebar-text: #ecf0f1;
      --sidebar-border: rgba(255,255,255,0.1);
      --success-color: #2ecc71;
      --warning-color: #f1c40f;
      --info-bg: #1c3d5a;
      --info-text: #aed6f1;
      --avatar-bg: #2980b9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-dark);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* --- Login Screen --- */
    #login-screen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 500px;
        margin: 40px auto;
        padding: 40px 30px;
        background: var(--user-bubble-bg);
        border-radius: 16px;
        box-shadow: var(--shadow-medium);
        text-align: center;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    #login-screen.active {
        display: flex;
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-logo-container {
        display: flex;
        justify-content: center;
        margin-bottom: 25px;
    }

    .login-logo-border {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-accent), #3a7d5a);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-light);
        border: 3px solid white;
    }

    .login-logo {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border-color);
    }

    #login-screen h2 {
        font-size: 1.8rem;
        color: var(--text-dark);
        margin-bottom: 12px;
        font-weight: 700;
    }

    #login-screen p {
        color: var(--text-light);
        margin-bottom: 30px;
        max-width: 400px;
        font-size: 1rem;
        line-height: 1.7;
    }

    #login-form {
       width: 100%;
       max-width: 400px;
    }

    .form-group {
        margin-bottom: 24px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    .form-group input {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s ease;
        outline: none;
        background: var(--input-bg);
        color: var(--text-dark);
        box-shadow: var(--shadow-light);
    }

    .form-group input:focus {
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(90, 143, 123, 0.25);
    }

    #login-btn {
        width: 100%;
        padding: 14px;
        background: var(--button-primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        box-shadow: var(--shadow-light);
        margin-top: 10px;
        letter-spacing: 0.5px;
    }

    #login-btn:hover {
        background: var(--button-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    #login-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #login-error, #verification-info {
        margin-top: 15px;
        min-height: 20px;
        font-size: 0.95rem;
        padding: 12px 15px;
        border-radius: 10px;
        text-align: center;
    }

    #login-error {
        color: var(--error-color);
        background-color: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.2);
    }

    #verification-info {
        color: var(--info-text);
        background-color: var(--info-bg);
        display: none;
        line-height: 1.6;
    }

    .login-footer {
        margin-top: 25px;
        font-size: 0.95rem;
        color: var(--text-light);
    }

    .login-footer a {
        color: var(--link-color);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s ease;
    }

    .login-footer a:hover {
        color: var(--primary-accent);
        text-decoration: underline;
    }

    #forgot-password, #resend-verification {
        background: none;
        border: none;
        color: var(--link-color);
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 10px;
        padding: 0;
        font-family: inherit;
        display: block;
        width: fit-content;
        font-weight: 500;
    }

    #forgot-password:hover, #resend-verification:hover {
        color: var(--primary-accent);
    }

    /* --- Main Chat Interface --- */
    #main-container {
        display: none;
        flex-direction: column;
        width: 100%;
        height: 100vh;
        margin: 0 auto;
        flex-grow: 1;
    }

    #main-container.active {
        display: flex;
        animation: fadeIn 0.4s ease;
    }

    /* ChatGPT-like layout */
    .chat-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        background: var(--background-light);
    }

    /* Sidebar - Mimicking ChatGPT sidebar */
    .sidebar {
        width: 280px;
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--sidebar-border);
        transition: all 0.3s ease;
        flex-shrink: 0;
        box-shadow: var(--shadow-medium);
        z-index: 10;
    }

    .sidebar-header {
        padding: 25px 20px;
        border-bottom: 1px solid var(--sidebar-border);
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .logo-border {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary-accent), #3a7d5a);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-light);
    }

    .logo {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        object-fit: cover;
    }

    .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .new-chat-btn {
        margin: 20px 0;
        padding: 14px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--sidebar-text);
        border: 1px solid var(--sidebar-border);
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        font-family: inherit;
    }

    .new-chat-btn:hover {
        background-color: rgba(255,255,255,0.15);
        transform: translateY(-2px);
        box-shadow: var(--shadow-light);
    }

    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px 0;
    }

    .sidebar-links {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0 12px;
    }

    .sidebar-link {
        padding: 12px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        border-radius: 10px;
        margin: 0 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--sidebar-text);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.05);
    }

    .sidebar-link:hover {
        background-color: rgba(255,255,255,0.1);
        transform: translateX(5px);
    }

    .sidebar-link i {
        width: 22px;
        text-align: center;
        font-size: 1.1rem;
    }

    .theme-toggle {
        padding: 12px 18px;
        font-size: 0.95rem;
        cursor: pointer;
        border-radius: 10px;
        margin: 0 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--sidebar-text);
        background: rgba(255, 255, 255, 0.05);
        border: none;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        font-family: inherit;
        width: calc(100% - 16px);
    }

    .theme-toggle:hover {
        background-color: rgba(255,255,255,0.1);
        transform: translateX(5px);
    }

    .theme-toggle i {
        width: 22px;
        text-align: center;
        font-size: 1.1rem;
    }

    .sidebar-footer {
        padding: 20px;
        border-top: 1px solid var(--sidebar-border);
        font-size: 0.9rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--avatar-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        box-shadow: var(--shadow-light);
    }

    #logoutBtn {
        width: 100%;
        padding: 12px;
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        box-shadow: var(--shadow-light);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    #logoutBtn:hover {
        background: rgba(231, 76, 60, 0.25);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    /* Download button */
    #downloadBtn {
        width: 100%;
        padding: 12px;
        background: rgba(46, 204, 113, 0.15);
        color: var(--success-color);
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        box-shadow: var(--shadow-light);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
    }

    #downloadBtn:hover {
        background: rgba(46, 204, 113, 0.25);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    /* Main Chat Area */
    .main-chat-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background-color: var(--background-light);
        transition: background-color 0.3s ease;
        position: relative;
    }

    /* Chat Display Area - Matches ChatGPT */
    #chatbox {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      transition: background-color 0.3s ease;
    }

    .message {
      padding: 24px 0;
      position: relative;
      line-height: 1.7;
      word-wrap: break-word;
      font-size: 1.05rem;
      border-bottom: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInSlideUp 0.4s forwards;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .message:last-child {
        border-bottom: none;
    }

    /* Keyframes for animation */
    @keyframes fadeInSlideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-content-wrapper {
        display: flex;
        gap: 25px;
        margin: 0 auto;
        max-width: 800px;
        width: 90%;
        padding: 0 20px;
    }

    .message-icon {
        flex-shrink: 0;
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        box-shadow: var(--shadow-light);
    }

    .user .message-icon {
        background-color: var(--avatar-bg);
    }

    .bot .message-icon {
        background-color: var(--primary-accent);
    }

    .message-content {
        flex-grow: 1;
        padding-top: 5px;
    }

    .user {
      background-color: var(--user-bubble-bg);
    }

    .bot {
      background-color: var(--bot-bubble-bg);
    }

    .message strong {
      display: block;
      margin-bottom: 12px;
      font-weight: 700;
      font-size: 1.15em;
      color: var(--text-dark);
    }

    .message .message-text {
        line-height: 1.7;
    }

    .message .message-text p {
        margin-bottom: 12px;
    }

    /* Input Section - Matches ChatGPT input bar */
    #inputForm {
      padding: 20px 0;
      background: var(--bot-bubble-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: center;
      position: relative;
      transition: all 0.3s ease;
    }

    .input-container-wrapper {
        position: relative;
        width: 100%;
        max-width: 800px;
        padding: 0 20px;
    }

    .input-container {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #question {
      width: 100%;
      min-height: 65px;
      max-height: 200px;
      padding: 18px 60px 18px 20px;
      font-size: 1.05rem;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      outline: none;
      transition: all 0.3s ease;
      font-family: inherit;
      resize: none;
      overflow-y: auto;
      line-height: 1.7;
      color: var(--text-dark);
      box-shadow: var(--shadow-light);
    }

    #question:focus {
      border-color: var(--primary-accent);
      box-shadow: 0 0 0 3px rgba(90, 143, 123, 0.25);
    }

    #submitBtn {
      position: absolute;
      right: 15px;
      bottom: 15px;
      padding: 10px;
      background: var(--button-primary);
      color: white;
      border: none;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      box-shadow: var(--shadow-light);
    }

    #submitBtn:hover {
      background: var(--button-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    #submitBtn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .input-footer {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      font-size: 0.85rem;
      color: var(--text-light);
      opacity: 0.7;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 24px 0;
      background-color: var(--bot-bubble-bg);
      border-bottom: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInSlideUp 0.4s forwards;
    }

    .typing-content-wrapper {
        display: flex;
        gap: 25px;
        margin: 0 auto;
        max-width: 800px;
        width: 90%;
        padding: 0 20px;
    }

    .typing-icon {
        flex-shrink: 0;
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        background-color: var(--primary-accent);
        box-shadow: var(--shadow-light);
    }

    .typing-dots-container {
        display: flex;
        align-items: center;
        padding-top: 5px;
    }

    .typing-dot {
      width: 10px;
      height: 10px;
      background-color: var(--typing-dot-color);
      border-radius: 50%;
      margin: 0 4px;
      opacity: 0.7;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-6px); opacity: 1; }
    }

    /* Mobile Sidebar Toggle Button */
    .sidebar-toggle {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 101;
        background: var(--primary-accent);
        color: white;
        border: none;
        border-radius: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: var(--shadow-medium);
        display: none; /* Hidden by default */
    }
    
    /* Overlay for mobile sidebar */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 99;
        display: none;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translateX(-100%);
            z-index: 100;
            width: 280px;
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-toggle {
            display: flex;
        }
        
        .input-container-wrapper {
            padding: 0 15px;
        }
    }

    @media (max-width: 480px) {
        .message-content-wrapper, .typing-content-wrapper, .input-container-wrapper {
            padding: 0 15px;
            gap: 20px;
        }

        .input-footer {
            font-size: 0.75rem;
            padding: 0 10px;
        }

        #question {
            min-height: 55px;
            padding: 14px 50px 14px 14px;
            font-size: 1rem;
        }

        #submitBtn {
            right: 10px;
            bottom: 10px;
            width: 36px;
            height: 36px;
            padding: 8px;
        }

        .message {
            padding: 20px 0;
        }
        
        .message-icon, .typing-icon {
            width: 34px;
            height: 34px;
            font-size: 14px;
        }
        
        .login-logo-border {
            width: 85px;
            height: 85px;
        }
        
        .login-logo {
            width: 75px;
            height: 75px;
        }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <div class="login-logo-container">
      <div class="login-logo-border">
        <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/06/screenshot-2025-01-16-124913.png" alt="Dalswin School Logo" class="login-logo">
      </div>
    </div>
    <h2>Welcome Back to Dalswin</h2>
    <p>Sign in to access our AI-powered learning assistant designed to help you succeed in your studies.</p>
    <form id="login-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required autocomplete="username" placeholder="student@dalswin.edu">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required autocomplete="current-password" placeholder="Enter your password">
        <button type="button" id="forgot-password">Forgot Password?</button>
      </div>
      <button type="submit" id="login-btn">Sign In</button>
      <div id="login-error"></div>
      <div id="verification-info">A verification email has been sent. Please check your inbox. <button type="button" id="resend-verification">Resend Verification</button></div>
    </form>
    <div class="login-footer">
      Don't have an account? <a href="https://lifelight.foundation/apply-now/" target="_blank" rel="noopener noreferrer">Sign Up Here</a>
    </div>
  </div>

  <!-- Main Chat Interface Container -->
  <div id="main-container">
    <div class="chat-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-border">
                        <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/06/screenshot-2025-01-16-124913.png" alt="Dalswin School Logo" class="logo">
                    </div>
                    <div class="logo-text">Dalswin AI</div>
                </div>
                <button class="new-chat-btn">
                    <i class="fas fa-plus"></i> New chat
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-links">
                    <a href="https://lifelight.foundation/dalswin-learning-assistant/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-info-circle"></i> About the Chatbot
                    </a>
                    <a href="https://lifelight.foundation/contact-2/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-envelope"></i> Contact & Support
                    </a>
                    <a href="https://lifelight.foundation/private-policy/#" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-lock"></i> Privacy Policy
                    </a>
                    <a href="https://lifelight.foundation/230-2/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-building"></i> About Us
                    </a>
                     <button class="theme-toggle" id="theme-toggle">
                        <i class="fas fa-moon"></i> <span id="theme-text">Dark Mode</span>
                    </button>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-name" id="user-name">User</div>
                </div>
                <button id="downloadBtn">
                    <i class="fas fa-file-download"></i> Download Chat
                </button>
                <button id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Overlay for mobile sidebar -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Chat Area -->
        <div class="main-chat-area">
            <!-- Mobile Sidebar Toggle Button -->
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div id="chatbox">
                <div class="message bot">
                    <div class="message-content-wrapper">
                        <div class="message-icon"><i class="fas fa-graduation-cap"></i></div>
                        <div class="message-content">
                            <strong>Dalswin Assistant:</strong>
                            <div class="message-text">
                                <p>Hello! I'm your Dalswin School assistant. How can I help you with your studies today? Feel free to ask about any subject, homework, or school-related topics.</p>
                                <p>I'll remember our conversation based on your school email to provide personalized assistance throughout your learning journey.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <form id="inputForm">
                <div class="input-container-wrapper">
                    <div class="input-container">
                        <textarea
                            id="question"
                            placeholder="Message Dalswin Assistant..."
                            maxlength="500"
                            autocomplete="off"
                            required
                        ></textarea>
                        <button type="submit" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-footer">
                        Dalswin School Assistant can make mistakes. Consider verifying important information.
                    </div>
                </div>
            </form>
        </div>
    </div>
  </div>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDM1LGJdUBN8zDLCzTjjxQtkzkeUHtuCSU",
      authDomain: "dashboard-c0263.firebaseapp.com",
      projectId: "dashboard-c0263",
      storageBucket: "dashboard-c0263.firebasestorage.app",
      messagingSenderId: "177312727757",
      appId: "1:177312727757:web:5d2d926a71eb12d503df84"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Global variable to store current user's email
    let currentUserEmail = '';

    // --- Theme Toggle Logic ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeText = document.getElementById('theme-text');
    const themeIcon = themeToggle.querySelector('i');

    // Check for saved theme preference or respect OS setting
    const savedTheme = localStorage.getItem('theme');
    const osPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme ? savedTheme : (osPrefersDark ? 'dark' : 'light');

    // Apply initial theme
    if (initialTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeText.textContent = 'Light Mode';
        themeIcon.className = 'fas fa-sun';
    } else {
        // Light mode is default, ensure class is removed
        document.body.classList.remove('dark-mode');
        themeText.textContent = 'Dark Mode';
        themeIcon.className = 'fas fa-moon';
    }

    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        themeText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
    });
    // --- End Theme Toggle Logic ---

    // DOM Elements
    const loginScreen = document.getElementById('login-screen');
    const mainContainer = document.getElementById('main-container');
    const loginForm = document.getElementById('login-form');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const verificationInfo = document.getElementById('verification-info');
    const forgotPasswordBtn = document.getElementById('forgot-password');
    const resendVerificationBtn = document.getElementById('resend-verification');
    const chatbox = document.getElementById('chatbox');
    const form = document.getElementById('inputForm');
    const input = document.getElementById('question');
    const submitBtn = document.getElementById('submitBtn');
    const messages = [];
    let isBotTyping = false;
    
    // Mobile sidebar toggle elements
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.querySelector('.sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    // --- Firebase Email Verification System ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log("Auth state changed. User:", user.email, "Verified:", user.emailVerified);
        
        if (!user.emailVerified) {
          // Show alert and send verification email
          alert("⚠️ Please verify your email before continuing. A new verification link has been sent to your email.");
          
          // Send verification email
          try {
            await user.sendEmailVerification();
            console.log("Verification email sent to:", user.email);
          } catch (error) {
            console.error("Error sending verification email:", error);
          }
          
          // Sign out the user
          await auth.signOut();
          return;
        }
        
        // If verified, proceed normally
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        const displayName = user.email.split('@')[0] || 'User';
        userNameElement.textContent = displayName;
        userAvatarElement.textContent = displayName.charAt(0).toUpperCase();
        currentUserEmail = user.email; // Store user email for memory feature
        
        console.log("User is signed in and verified.");
        showMainInterface();
      } else {
        console.log("No user is signed in.");
        currentUserEmail = ''; // Clear email when user logs out
        showLoginInterface();
      }
    });

    // Resend verification email function
    async function resendVerification() {
      const user = auth.currentUser;
      if (user && !user.emailVerified) {
        try {
          await user.sendEmailVerification();
          alert("✅ Verification email sent again. Please check your inbox.");
          console.log("Verification email resent to:", user.email);
        } catch (error) {
          console.error("Resend verification error:", error);
          alert("❌ Failed to resend verification email. Please try again later.");
        }
      } else {
        alert("Your email is already verified or you are not signed in.");
      }
    }

    // Escape HTML to prevent injection
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (match) => {
        const escapeMap = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        };
        return escapeMap[match];
      });
    }

    // Auto-resize textarea function
    function autoResize() {
      input.style.height = 'auto';
      input.style.height = (input.scrollHeight) + 'px';
      if (input.scrollHeight > 200) {
        input.style.overflowY = 'auto';
      } else {
        input.style.overflowY = 'hidden';
      }
    }

    autoResize();
    input.addEventListener('input', autoResize);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!submitBtn.disabled) {
            form.dispatchEvent(new Event('submit'));
        }
      }
    });

    function showTypingIndicator() {
      if (isBotTyping) return;
      isBotTyping = true;
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="typing-content-wrapper">
            <div class="typing-icon"><i class="fas fa-robot"></i></div>
            <div class="typing-dots-container">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
      `;
      chatbox.appendChild(typingDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function hideTypingIndicator() {
      isBotTyping = false;
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function appendMessage(sender, text, className) {
      const msg = document.createElement('div');
      msg.className = `message ${className}`;
      let iconHtml = '';
      if (className === 'user') {
        iconHtml = '<div class="message-icon"><i class="fas fa-user"></i></div>';
      } else {
        iconHtml = '<div class="message-icon"><i class="fas fa-robot"></i></div>';
      }

      if (className === 'bot') {
        const escapedText = escapeHTML(text).replace(/\n/g, '<br>');
        msg.innerHTML = `
            <div class="message-content-wrapper">
                ${iconHtml}
                <div class="message-content"><strong>${sender}:</strong><div class="message-text">${escapedText}</div></div>
            </div>
        `;
      } else {
        msg.innerHTML = `
            <div class="message-content-wrapper">
                ${iconHtml}
                <div class="message-content"><strong>${sender}:</strong> <div class="message-text">${escapeHTML(text)}</div></div>
            </div>
        `;
      }
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
      messages.push({ sender, text });
    }

    // --- Authentication Logic ---
    function showLoginInterface(clearError = true) {
        loginScreen.classList.add('active');
        mainContainer.classList.remove('active');
        if (clearError) {
            loginError.textContent = '';
            verificationInfo.style.display = 'none';
        }
    }

    function showMainInterface() {
        loginScreen.classList.remove('active');
        mainContainer.classList.add('active');
        input.focus();
    }

    // Handle Login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        if (!email || !password) {
            loginError.textContent = 'Please enter both email and password.';
            return;
        }
        loginBtn.disabled = true;
        loginError.textContent = '';
        verificationInfo.style.display = 'none';

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            console.log("Login successful for:", user.email);
            currentUserEmail = user.email;
            
            // Check verification status immediately after login
            if (user.emailVerified) {
                console.log("User logged in and is verified.");
            } else {
                console.log("User logged in but NOT verified.");
                // Show verification message
                loginError.textContent = 'Please verify your email address before continuing.';
                verificationInfo.style.display = 'block';
                // Sign out the unverified user to prevent access
                await auth.signOut();
            }
        } catch (error) {
            console.error("Login error:", error);
            let errorMessage = "Login failed. Please try again.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                 errorMessage = "Invalid email or password.";
            } else if (error.code === 'auth/invalid-email') {
                 errorMessage = "Invalid email address format.";
            } else if (error.code === 'auth/too-many-requests') {
                 errorMessage = "Too many failed attempts. Try again later or reset your password.";
            } else if (error.code === 'auth/user-disabled') {
                 errorMessage = "This account has been disabled.";
            }
            loginError.textContent = errorMessage;
            verificationInfo.style.display = 'none';
        } finally {
             loginBtn.disabled = false;
        }
    });

    // Handle Password Reset
    forgotPasswordBtn.addEventListener('click', async () => {
         const email = prompt("Please enter your email address to receive a password reset link:");
         if (!email) return;
         try {
             await auth.sendPasswordResetEmail(email);
             alert("Password reset email sent! Please check your inbox.");
         } catch (error) {
             console.error("Password reset error:", error);
             let resetErrorMessage = "Failed to send reset email. Please try again.";
             if (error.code === 'auth/user-not-found') {
                 resetErrorMessage = "No user found with that email address.";
             } else if (error.code === 'auth/invalid-email') {
                 resetErrorMessage = "Invalid email address format.";
             }
             alert(resetErrorMessage);
         }
    });

    // Handle Resend Verification Email
    resendVerificationBtn.addEventListener('click', resendVerification);

    // Enhanced Logout Functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await auth.signOut();
            console.log("User signed out.");
            // Clear chat and reset interface
            chatbox.innerHTML = '';
            messages.length = 0;
            // Add initial bot message again
            setTimeout(() => {
                appendMessage('Dalswin Assistant', 'Hello! How can I assist you today?', 'bot');
            }, 300);
            // Show login screen
            showLoginInterface();
        } catch (error) {
            console.error("Logout error:", error);
            alert("An error occurred during logout. Please try again.");
        }
    });

    // --- Enhanced Chatbot Logic with Memory ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;
      if (!currentUserEmail) {
        alert("Please sign in to use the chatbot");
        return;
      }
      
      appendMessage('You', question, 'user');
      input.value = '';
      autoResize();
      input.disabled = true;
      submitBtn.disabled = true;
      showTypingIndicator();
      
      try {
        const response = await fetch('https://chartbot-production.up.railway.app/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            question,
            userEmail: currentUserEmail
          }),
        });
        
        const data = await response.json();
        hideTypingIndicator();
        appendMessage('Dalswin Assistant', data.answer || 'I couldn\'t find an answer to that question.', 'bot');
      } catch (err) {
        hideTypingIndicator();
        appendMessage('Dalswin Assistant', '❌ Error connecting to the server. Please try again.', 'bot');
        console.error(err);
      } finally {
        input.disabled = false;
        submitBtn.disabled = false;
        input.focus();
      }
    });

    // Sidebar new chat button
    document.querySelector('.new-chat-btn')?.addEventListener('click', () => {
        console.log("New chat started");
        chatbox.innerHTML = '';
        messages.length = 0;
        setTimeout(() => {
            appendMessage('Dalswin Assistant', 'Hello! I\'m ready for a new conversation. How can I assist you today?', 'bot');
        }, 300);
    });
    
    // --- Conversation Download Functionality ---
    document.getElementById('downloadBtn').addEventListener('click', () => {
        if (!currentUserEmail) {
            alert("Please sign in to download your conversation");
            return;
        }
        
        if (messages.length === 0) {
            alert("No conversation to download");
            return;
        }
        
        // Create a well-formatted Word document
        const content = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Dalswin Chat Conversation</title>
                <style>
                    body {
                        font-family: 'Inter', sans-serif;
                        line-height: 1.6;
                        color: #333;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 30px;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 30px;
                        border-bottom: 2px solid #5a8f7b;
                        padding-bottom: 20px;
                    }
                    .logo {
                        width: 80px;
                        height: 80px;
                        margin-bottom: 15px;
                    }
                    h1 {
                        color: #2c3e50;
                        margin-bottom: 10px;
                    }
                    .user-info {
                        font-size: 0.9rem;
                        color: #666;
                        margin-bottom: 30px;
                    }
                    .message {
                        margin-bottom: 25px;
                        padding-bottom: 15px;
                        border-bottom: 1px solid #eee;
                    }
                    .user-message .sender {
                        color: #3498db;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .bot-message .sender {
                        color: #5a8f7b;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .timestamp {
                        font-size: 0.8rem;
                        color: #999;
                        margin-top: 5px;
                    }
                    .content {
                        line-height: 1.6;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/06/screenshot-2025-01-16-124913.png" alt="Dalswin Logo" class="logo">
                    <h1>Dalswin School Chat Conversation</h1>
                    <div class="user-info">
                        <div>User: ${document.getElementById('user-name').textContent}</div>
                        <div>Email: ${currentUserEmail}</div>
                        <div>Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                <div class="messages">
                    ${messages.map(msg => `
                        <div class="message ${msg.sender === 'You' ? 'user-message' : 'bot-message'}">
                            <div class="sender">${msg.sender}:</div>
                            <div class="content">${msg.text.replace(/\n/g, '<br>')}</div>
                            <div class="timestamp">${new Date().toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
            </body>
            </html>
        `;
        
        // Create and trigger download
        const blob = new Blob([content], {type: 'application/msword'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Dalswin_Chat_${currentUserEmail.split('@')[0]}_${new Date().toISOString().slice(0,10)}.doc`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show download confirmation
        const downloadConfirmation = document.createElement('div');
        downloadConfirmation.textContent = 'Conversation downloaded successfully!';
        downloadConfirmation.style.position = 'fixed';
        downloadConfirmation.style.bottom = '20px';
        downloadConfirmation.style.right = '20px';
        downloadConfirmation.style.backgroundColor = 'var(--success-color)';
        downloadConfirmation.style.color = 'white';
        downloadConfirmation.style.padding = '12px 20px';
        downloadConfirmation.style.borderRadius = '8px';
        downloadConfirmation.style.boxShadow = 'var(--shadow-medium)';
        downloadConfirmation.style.zIndex = '1000';
        document.body.appendChild(downloadConfirmation);
        
        setTimeout(() => {
            document.body.removeChild(downloadConfirmation);
        }, 3000);
    });
    
    // --- Mobile Sidebar Toggle Logic ---
    sidebarToggle?.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        sidebarOverlay.classList.toggle('active');
    });
    
    sidebarOverlay?.addEventListener('click', () => {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    });
  </script>
</body>
</html>
