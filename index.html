<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dalswin School Chatbot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- Firebase App (the core Firebase SDK) and Auth SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <style>
    :root {
      /* --- Light Mode Default (your specified colors) --- */
      --primary-accent: #b1c5a4; /* Light greenish - Growth/Trust */
      --background-light: #f9f9f9; /* Very light grey/white */
      --secondary-accent: #b5bdbc; /* Muted grey/green */
      --text-dark: #202123; /* Dark text */
      --text-light: #343541; /* Slightly lighter dark text */
      --border-color: #e5e5e5; /* Subtle border */
      --user-bubble-bg: #ffffff; /* User message - White */
      --bot-bubble-bg: #f7f7f8; /* Bot message - Light grey */
      --input-bg: #ffffff; /* Input background */
      --button-primary: var(--primary-accent); /* Primary button */
      --button-hover: #9cb58f; /* Button hover */
      --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --error-color: #ef4444;
      --link-color: #3b82f6;
      --typing-dot-color: var(--primary-accent);
      --sidebar-bg: #202123; /* Sidebar background */
      --sidebar-text: #ececf1; /* Sidebar text */
      --sidebar-border: rgba(255,255,255,0.2);
      --success-color: #10b981; /* For verification success */
      --warning-color: #f59e0b; /* For verification warning */
      --info-bg: #dbeafe; /* Info box background */
      --info-text: #1e40af; /* Info box text */
    }

    /* --- Dark Mode Variables --- */
    .dark-mode {
      --primary-accent: #8cb369; /* Slightly more vibrant green for dark mode */
      --background-light: #0f0f0f; /* Very dark background */
      --secondary-accent: #3a3a3a; /* Darker grey */
      --text-dark: #e4e4e4; /* Light text */
      --text-light: #c7c7c7; /* Slightly darker light text */
      --border-color: #343541; /* Darker border */
      --user-bubble-bg: #343541; /* Darker user bubble */
      --bot-bubble-bg: #444654; /* Darker bot bubble */
      --input-bg: #40414f; /* Darker input */
      --button-primary: var(--primary-accent);
      --button-hover: #7a9c59;
      --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.2), 0 1px 2px -1px rgba(0, 0, 0, 0.2);
      --shadow-medium: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
      --error-color: #ef4444;
      --link-color: #60a5fa;
      --typing-dot-color: var(--primary-accent);
      --sidebar-bg: #202123; /* Keep sidebar dark */
      --sidebar-text: #ececf1;
      --sidebar-border: rgba(255,255,255,0.1);
      --success-color: #34d399;
      --warning-color: #fbbf24;
      --info-bg: #1e3a8a; /* Darker info box */
      --info-text: #bfdbfe;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-dark);
      line-height: 1.6;
      transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for mode change */
    }

    /* --- Login Screen --- */
    #login-screen {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
        background: var(--user-bubble-bg); /* Use theme background */
        border-radius: 8px;
        box-shadow: var(--shadow-medium);
        text-align: center;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    #login-screen.active {
        display: flex;
    }

    .login-logo-container {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }

    .login-logo-border {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        background: var(--primary-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-light);
    }

    .login-logo {
        width: 70px;
        height: 70px;
        border-radius: 6px;
        object-fit: cover;
        border: 1px solid var(--border-color);
    }

    #login-screen h2 {
        font-size: 1.5rem;
        color: var(--text-dark);
        margin-bottom: 10px;
        font-weight: 600;
    }

    #login-screen p {
        color: var(--text-light);
        margin-bottom: 30px;
        max-width: 500px;
        font-size: 0.95rem;
    }

    #login-form {
       width: 100%;
       max-width: 400px;
    }

    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .form-group input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        outline: none;
        background: var(--input-bg);
        color: var(--text-dark);
        box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.5);
    }

    .form-group input:focus {
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(177, 197, 164, 0.2);
    }

    #login-btn {
        width: 100%;
        padding: 12px;
        background: var(--button-primary);
        color: white;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-family: inherit;
        box-shadow: var(--shadow-light);
    }

    #login-btn:hover {
        background: var(--button-hover);
    }

    #login-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }

    #login-error, #verification-info {
        margin-top: 15px;
        min-height: 20px;
        font-size: 0.9rem;
        padding: 10px;
        border-radius: 6px;
    }

    #login-error {
        color: var(--error-color);
        background-color: rgba(239, 68, 68, 0.1);
    }

    #verification-info {
        color: var(--info-text);
        background-color: var(--info-bg);
        display: none; /* Hidden by default */
    }

    .login-footer {
        margin-top: 25px;
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .login-footer a {
        color: var(--link-color);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }

    .login-footer a:hover {
        color: var(--primary-accent);
        text-decoration: underline;
    }

    #forgot-password, #resend-verification {
        background: none;
        border: none;
        color: var(--link-color);
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.85rem;
        margin-top: 10px;
        padding: 0;
        font-family: inherit;
        display: block; /* Make it a block element */
        width: fit-content; /* Only take necessary width */
    }

    #forgot-password:hover, #resend-verification:hover {
        color: var(--primary-accent);
    }

    /* --- Main Chat Interface --- */
    #main-container {
        display: none;
        flex-direction: column;
        width: 100%;
        height: 100vh;
        margin: 0 auto;
        flex-grow: 1;
    }

    #main-container.active {
        display: flex;
    }

    /* ChatGPT-like layout */
    .chat-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* Sidebar - Mimicking ChatGPT sidebar */
    .sidebar {
        width: 260px;
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--sidebar-border);
        transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
        flex-shrink: 0;
    }

    .sidebar-header {
        padding: 20px 15px;
        border-bottom: 1px solid var(--sidebar-border);
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .logo-border {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        background: var(--primary-accent);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logo {
        width: 24px;
        height: 24px;
        border-radius: 3px;
        object-fit: cover;
    }

    .logo-text {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .new-chat-btn {
        margin: 15px 0;
        padding: 12px;
        background: transparent;
        color: var(--sidebar-text);
        border: 1px solid var(--sidebar-border);
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        font-family: inherit;
    }

    .new-chat-btn:hover {
        background-color: rgba(255,255,255,0.1);
    }

    .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px 0;
    }

    .sidebar-links {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 0 8px;
    }

    .sidebar-link {
        padding: 10px 15px;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 6px;
        margin: 0 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--sidebar-text);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background-color 0.2s ease;
    }

    .sidebar-link:hover {
        background-color: rgba(255,255,255,0.1);
    }

    .sidebar-link i {
        width: 20px;
        text-align: center;
    }

    .theme-toggle {
        padding: 10px 15px;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 6px;
        margin: 0 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--sidebar-text);
        background: transparent;
        border: none;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background-color 0.2s ease;
        font-family: inherit;
        width: calc(100% - 16px); /* Account for margin */
    }

    .theme-toggle:hover {
        background-color: rgba(255,255,255,0.1);
    }

    .theme-toggle i {
        width: 20px;
        text-align: center;
    }

    .sidebar-footer {
        padding: 15px;
        border-top: 1px solid var(--sidebar-border);
        font-size: 0.85rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        background-color: var(--primary-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
    }

    #logoutBtn {
        background: none;
        border: none;
        color: var(--sidebar-text);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 5px 0;
        text-align: left;
        width: 100%;
        transition: color 0.2s ease;
        font-family: inherit;
    }

    #logoutBtn:hover {
        color: var(--primary-accent);
    }

    /* Main Chat Area */
    .main-chat-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background-color: var(--background-light);
        transition: background-color 0.3s ease;
    }

    /* Chat Display Area - Matches ChatGPT */
    #chatbox {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: var(--bot-bubble-bg);
      padding-bottom: 20px;
      transition: background-color 0.3s ease;
    }

    .message {
      padding: 24px 0;
      position: relative;
      line-height: 1.6;
      word-wrap: break-word;
      font-size: 1rem;
      border-bottom: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInSlideUp 0.4s forwards; /* Apply animation */
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .message:last-child {
        border-bottom: none;
    }

    /* Keyframes for animation */
    @keyframes fadeInSlideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-content-wrapper {
        display: flex;
        gap: 30px;
        margin: 0 auto;
        max-width: 800px;
        width: 100%;
        padding: 0 20px;
    }

    .message-icon {
        flex-shrink: 0;
        width: 30px;
        height: 30px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
    }

    .user .message-icon {
        background-color: #10a37f; /* ChatGPT user icon color */
    }

    .bot .message-icon {
        background-color: #5436da; /* ChatGPT bot icon color */
    }

    .message-content {
        flex-grow: 1;
        padding-top: 3px;
    }

    .user {
      background-color: var(--user-bubble-bg);
    }

    .bot {
      background-color: var(--bot-bubble-bg);
    }

    .message strong {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 1.05em;
    }

    /* Input Section - Matches ChatGPT input bar */
    #inputForm {
      padding: 20px 0;
      background: var(--bot-bubble-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: center;
      position: relative;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .input-container-wrapper {
        position: relative;
        width: 100%;
        max-width: 800px;
        padding: 0 20px;
    }

    .input-container {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #question {
      width: 100%;
      min-height: 60px;
      max-height: 200px;
      padding: 16px 50px 16px 16px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
      font-family: inherit;
      resize: none;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--text-dark);
      box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.5);
    }

    #question:focus {
      border-color: var(--primary-accent);
      box-shadow: 0 0 0 3px rgba(177, 197, 164, 0.2);
    }

    #submitBtn {
      position: absolute;
      right: 12px;
      bottom: 12px;
      padding: 8px;
      background: var(--button-primary);
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    #submitBtn:hover {
      background: var(--button-hover);
    }

    #submitBtn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }

    .input-footer {
      display: flex;
      justify-content: center;
      margin-top: 12px;
      font-size: 0.75rem;
      color: var(--text-light);
      opacity: 0.6;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 24px 0;
      background-color: var(--bot-bubble-bg);
      border-bottom: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInSlideUp 0.4s forwards;
    }

    .typing-content-wrapper {
        display: flex;
        gap: 30px;
        margin: 0 auto;
        max-width: 800px;
        width: 100%;
        padding: 0 20px;
    }

    .typing-icon {
        flex-shrink: 0;
        width: 30px;
        height: 30px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        background-color: #5436da;
    }

    .typing-dots-container {
        display: flex;
        align-items: center;
        padding-top: 3px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: var(--typing-dot-color);
      border-radius: 50%;
      margin: 0 3px;
      opacity: 0.6;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); opacity: 1; }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translateX(-100%);
            z-index: 100;
        }

        .sidebar.active {
            transform: translateX(0);
        }
    }

    @media (max-width: 480px) {
        .message-content-wrapper, .typing-content-wrapper, .input-container-wrapper {
            padding: 0 15px;
            gap: 20px;
        }

        .input-footer {
            font-size: 0.65rem;
        }

        #question {
            min-height: 50px;
            padding: 12px 40px 12px 12px;
            font-size: 0.95rem;
        }

        #submitBtn {
            right: 8px;
            bottom: 8px;
            width: 28px;
            height: 28px;
            padding: 6px;
        }

        .message {
            padding: 20px 0;
        }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <div class="login-logo-container">
      <div class="login-logo-border">
        <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/07/chatgpt-image-jul-26-2025-10_55_03-am.png" alt="Dalswin School Logo" class="login-logo">
      </div>
    </div>
    <h2>Welcome Back</h2>
    <p>Please sign in to access the Dalswin School Chatbot.</p>
    <form id="login-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required autocomplete="username">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required autocomplete="current-password">
        <button type="button" id="forgot-password">Forgot Password?</button>
      </div>
      <button type="submit" id="login-btn">Sign In</button>
      <div id="login-error"></div>
      <div id="verification-info">A verification email has been sent. Please check your inbox. <button type="button" id="resend-verification">Resend Verification</button></div>
    </form>
    <div class="login-footer">
      Don't have an account? <a href="https://lifelight.foundation/apply-now/" target="_blank" rel="noopener noreferrer">Sign Up Here</a>
    </div>
  </div>

  <!-- Main Chat Interface Container -->
  <div id="main-container">
    <div class="chat-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-border">
                        <img src="https://lifelightfoundation.wordpress.com/wp-content/uploads/2025/07/chatgpt-image-jul-26-2025-10_55_03-am.png" alt="Dalswin School Logo" class="logo">
                    </div>
                    <div class="logo-text">Dalswin Chat</div>
                </div>
                <button class="new-chat-btn">
                    <i class="fas fa-plus"></i> New chat
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-links">
                    <a href="https://lifelight.foundation/dalswin-learning-assistant/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-info-circle"></i> About the Chatbot
                    </a>
                    <a href="https://lifelight.foundation/contact-2/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-envelope"></i> Contact & Support
                    </a>
                    <a href="https://lifelight.foundation/private-policy/#" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-lock"></i> Privacy Policy
                    </a>
                    <a href="https://lifelight.foundation/230-2/" target="_blank" rel="noopener noreferrer" class="sidebar-link">
                        <i class="fas fa-building"></i> About Us
                    </a>
                     <button class="theme-toggle" id="theme-toggle">
                        <i class="fas fa-moon"></i> <span id="theme-text">Dark Mode</span>
                    </button>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-name" id="user-name">User</div>
                </div>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat-area">
            <div id="chatbox">
                <div class="message bot">
                    <div class="message-content-wrapper">
                        <div class="message-icon"><i class="fas fa-robot"></i></div>
                        <div class="message-content">
                            <strong>School Assistant:</strong>
                            Hello! I'm your Dalswin School assistant. How can I help you with your studies today? Feel free to ask about any subject, homework, or school-related topics.
                        </div>
                    </div>
                </div>
                <div class="message bot">
                    <div class="message-content-wrapper">
                        <div class="message-icon"><i class="fas fa-robot"></i></div>
                        <div class="message-content">
                            <strong>School Assistant:</strong>
                            Here's an example of a longer response to demonstrate the improved readability: Photosynthesis is the process used by plants, algae, and certain bacteria to harness energy from sunlight and turn it into chemical energy. There are two main stages: light-dependent reactions and the Calvin cycle. Light-dependent reactions use energy from sunlight to produce ATP and NADPH. These energy carriers are then used in the Calvin cycle to convert carbon dioxide into glucose. This process is essential for life on Earth as it provides oxygen and forms the basis of most food chains.
                        </div>
                    </div>
                </div>
            </div>
            <form id="inputForm">
                <div class="input-container-wrapper">
                    <div class="input-container">
                        <textarea
                            id="question"
                            placeholder="Message Dalswin Assistant..."
                            maxlength="500"
                            autocomplete="off"
                            required
                        ></textarea>
                        <button type="submit" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-footer">
                        Dalswin School Assistant can make mistakes. Consider checking important information.
                    </div>
                </div>
            </form>
        </div>
    </div>
  </div>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDM1LGJdUBN8zDLCzTjjxQtkzkeUHtuCSU",
      authDomain: "dashboard-c0263.firebaseapp.com",
      projectId: "dashboard-c0263",
      storageBucket: "dashboard-c0263.firebasestorage.app",
      messagingSenderId: "177312727757",
      appId: "1:177312727757:web:5d2d926a71eb12d503df84"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // --- Theme Toggle Logic ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeText = document.getElementById('theme-text');
    const themeIcon = themeToggle.querySelector('i');

    // Check for saved theme preference or respect OS setting
    const savedTheme = localStorage.getItem('theme');
    const osPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme ? savedTheme : (osPrefersDark ? 'dark' : 'light');

    // Apply initial theme
    if (initialTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeText.textContent = 'Light Mode';
        themeIcon.className = 'fas fa-sun';
    } else {
        // Light mode is default, ensure class is removed
        document.body.classList.remove('dark-mode');
        themeText.textContent = 'Dark Mode';
        themeIcon.className = 'fas fa-moon';
    }

    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        themeText.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
        themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
    });
    // --- End Theme Toggle Logic ---

    // DOM Elements
    const loginScreen = document.getElementById('login-screen');
    const mainContainer = document.getElementById('main-container');
    const loginForm = document.getElementById('login-form');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const verificationInfo = document.getElementById('verification-info');
    const forgotPasswordBtn = document.getElementById('forgot-password');
    const resendVerificationBtn = document.getElementById('resend-verification');
    const chatbox = document.getElementById('chatbox');
    const form = document.getElementById('inputForm');
    const input = document.getElementById('question');
    const submitBtn = document.getElementById('submitBtn');
    const messages = [];
    let isBotTyping = false;

    // Escape HTML to prevent injection
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (match) => {
        const escapeMap = {
          '&': '&amp;',
          '<': '<',
          '>': '>',
          '"': '&quot;',
          "'": '&#39;',
        };
        return escapeMap[match];
      });
    }

    // Auto-resize textarea function
    function autoResize() {
      input.style.height = 'auto';
      input.style.height = (input.scrollHeight) + 'px';
      if (input.scrollHeight > 200) {
        input.style.overflowY = 'auto';
      } else {
        input.style.overflowY = 'hidden';
      }
    }

    autoResize();
    input.addEventListener('input', autoResize);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!submitBtn.disabled) {
            form.dispatchEvent(new Event('submit'));
        }
      }
    });

    function showTypingIndicator() {
      if (isBotTyping) return;
      isBotTyping = true;
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="typing-content-wrapper">
            <div class="typing-icon"><i class="fas fa-robot"></i></div>
            <div class="typing-dots-container">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
      `;
      chatbox.appendChild(typingDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function hideTypingIndicator() {
      isBotTyping = false;
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function appendMessage(sender, text, className) {
      const msg = document.createElement('div');
      msg.className = `message ${className}`;
      let iconHtml = '';
      if (className === 'user') {
        iconHtml = '<div class="message-icon"><i class="fas fa-user"></i></div>';
      } else {
        iconHtml = '<div class="message-icon"><i class="fas fa-robot"></i></div>';
      }

      if (className === 'bot') {
        const escapedText = escapeHTML(text).replace(/\n/g, '<br>');
        msg.innerHTML = `
            <div class="message-content-wrapper">
                ${iconHtml}
                <div class="message-content"><strong>${sender}:</strong><div class="message-text">${escapedText}</div></div>
            </div>
        `;
      } else {
        msg.innerHTML = `
            <div class="message-content-wrapper">
                ${iconHtml}
                <div class="message-content"><strong>${sender}:</strong> <div class="message-text">${escapeHTML(text)}</div></div>
            </div>
        `;
      }
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
      messages.push({ sender, text });
    }

    // --- Enhanced Authentication Logic with Email Verification ---
    function showLoginInterface(clearError = true) {
        loginScreen.classList.add('active');
        mainContainer.classList.remove('active');
        if (clearError) {
            loginError.textContent = '';
            verificationInfo.style.display = 'none'; // Hide verification info on fresh login screen
        }
    }

    function showMainInterface() {
        loginScreen.classList.remove('active');
        mainContainer.classList.add('active');
        input.focus();
    }

    // Check auth state on page load and handle verification
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Auth state changed. User:", user.email, "Verified:", user.emailVerified);
            const userNameElement = document.getElementById('user-name');
            const userAvatarElement = document.getElementById('user-avatar');
            const displayName = user.email.split('@')[0] || 'User';
            userNameElement.textContent = displayName;
            userAvatarElement.textContent = displayName.charAt(0).toUpperCase();

            if (user.emailVerified) {
                console.log("User is signed in and verified.");
                showMainInterface();
            } else {
                console.log("User is signed in but NOT verified.");
                // Show login screen with verification message
                showLoginInterface(false); // Don't clear error/verification message
                loginError.textContent = '';
                verificationInfo.style.display = 'block'; // Show verification message
                // Optionally, you could automatically resend verification here, but better to wait for user action
            }
        } else {
            console.log("No user is signed in.");
            showLoginInterface();
        }
    });

    // Handle Login
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        if (!email || !password) {
            loginError.textContent = 'Please enter both email and password.';
            return;
        }
        loginBtn.disabled = true;
        loginError.textContent = '';
        verificationInfo.style.display = 'none'; // Hide previous verification message

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            console.log("Login successful for:", user.email);

            // Check verification status immediately after login
            if (user.emailVerified) {
                console.log("User logged in and is verified.");
                // showMainInterface will be called by onAuthStateChanged listener
            } else {
                console.log("User logged in but NOT verified.");
                // Update UI to show verification message
                loginError.textContent = 'Please verify your email address before continuing.';
                verificationInfo.style.display = 'block';
                // Sign out the unverified user to prevent access
                await auth.signOut();
            }
        } catch (error) {
            console.error("Login error:", error);
            let errorMessage = "Login failed. Please try again.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                 errorMessage = "Invalid email or password.";
            } else if (error.code === 'auth/invalid-email') {
                 errorMessage = "Invalid email address format.";
            } else if (error.code === 'auth/too-many-requests') {
                 errorMessage = "Too many failed attempts. Try again later or reset your password.";
            } else if (error.code === 'auth/user-disabled') {
                 errorMessage = "This account has been disabled.";
            }
            loginError.textContent = errorMessage;
            verificationInfo.style.display = 'none'; // Hide verification message on error
        } finally {
             loginBtn.disabled = false;
        }
    });

    // Handle Password Reset
    forgotPasswordBtn.addEventListener('click', async () => {
         const email = prompt("Please enter your email address to receive a password reset link:");
         if (!email) return;
         try {
             await auth.sendPasswordResetEmail(email);
             alert("Password reset email sent! Please check your inbox.");
         } catch (error) {
             console.error("Password reset error:", error);
             let resetErrorMessage = "Failed to send reset email. Please try again.";
             if (error.code === 'auth/user-not-found') {
                 resetErrorMessage = "No user found with that email address.";
             } else if (error.code === 'auth/invalid-email') {
                 resetErrorMessage = "Invalid email address format.";
             }
             alert(resetErrorMessage);
         }
    });

    // Handle Resend Verification Email
    resendVerificationBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (user) {
            try {
                await user.sendEmailVerification();
                alert("Verification email resent! Please check your inbox.");
                console.log("Verification email resent to:", user.email);
            } catch (error) {
                console.error("Resend verification error:", error);
                alert("Failed to resend verification email. Please try again later.");
            }
        } else {
            alert("No user is currently signed in.");
            showLoginInterface();
        }
    });

    // Handle Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            await auth.signOut();
            console.log("User signed out.");
            // UI update handled by onAuthStateChanged listener
        } catch (error) {
            console.error("Logout error:", error);
            alert("An error occurred during logout. Please try again.");
        }
    });

    // --- Existing Chatbot Logic ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;
      appendMessage('You', question, 'user');
      input.value = '';
      autoResize();
      input.disabled = true;
      submitBtn.disabled = true;
      showTypingIndicator();
      try {
        const response = await fetch('https://chartbot-production.up.railway.app/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question }),
        });
        const data = await response.json();
        hideTypingIndicator();
        appendMessage('School Assistant', data.answer || 'I couldn\'t find an answer to that question.', 'bot');
      } catch (err) {
        hideTypingIndicator();
        appendMessage('School Assistant', '❌ Error connecting to the server. Please try again.', 'bot');
        console.error(err);
      } finally {
        input.disabled = false;
        submitBtn.disabled = false;
        input.focus();
      }
    });

    // Sidebar new chat button
    document.querySelector('.new-chat-btn')?.addEventListener('click', () => {
        console.log("New chat started");
        chatbox.innerHTML = '';
        messages.length = 0;
        setTimeout(() => {
            appendMessage('School Assistant', 'Hello! How can I assist you today?', 'bot');
        }, 300);
    });
  </script>
</body>
</html>
